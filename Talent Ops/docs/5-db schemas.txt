DATABASE SCHEMAS (PostgreSQL / Supabase)
==========================================

-- 1. CORE ORGANIZATION & USER MANAGEMENT
-----------------------------------------

CREATE TABLE public.organizations (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE public.profiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id),
    org_id UUID REFERENCES public.organizations(id),
    email TEXT,
    full_name TEXT,
    role TEXT CHECK (role IN ('executive', 'manager', 'team_lead', 'employee')),
    job_title TEXT,
    department UUID, -- References departments(id)
    team_id UUID,
    avatar_url TEXT,
    join_date DATE,
    monthly_leave_quota INTEGER DEFAULT 3,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE public.departments (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    org_id UUID REFERENCES public.organizations(id),
    department_name TEXT NOT NULL
);

-- 2. MESSAGING SYSTEM
----------------------

CREATE TABLE public.conversations (
    id TEXT PRIMARY KEY, -- Can be UUID or custom string
    org_id UUID REFERENCES public.organizations(id),
    type TEXT CHECK (type IN ('dm', 'team', 'everyone')),
    name TEXT, -- For team chats
    created_by UUID REFERENCES public.profiles(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE public.conversation_members (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    conversation_id TEXT REFERENCES public.conversations(id),
    user_id UUID REFERENCES public.profiles(id),
    is_admin BOOLEAN DEFAULT FALSE,
    joined_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE public.messages (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    conversation_id TEXT REFERENCES public.conversations(id),
    sender_user_id UUID REFERENCES public.profiles(id),
    content TEXT,
    message_type TEXT DEFAULT 'chat',
    reply_to_id UUID REFERENCES public.messages(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE public.conversation_indexes (
    conversation_id TEXT PRIMARY KEY REFERENCES public.conversations(id),
    last_message TEXT,
    last_message_at TIMESTAMP WITH TIME ZONE,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE public.attachments (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    message_id UUID REFERENCES public.messages(id),
    file_name TEXT,
    file_type TEXT,
    file_size BIGINT,
    storage_path TEXT,
    url TEXT,
    uploaded_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. PAYROLL & ATTENDANCE (INFERRED)
-------------------------------------

CREATE TABLE public.attendance (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    org_id UUID REFERENCES public.organizations(id),
    employee_id UUID REFERENCES public.profiles(id),
    date DATE NOT NULL,
    clock_in TIME,
    clock_out TIME,
    current_task TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE public.leaves (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    org_id UUID REFERENCES public.organizations(id),
    employee_id UUID REFERENCES public.profiles(id),
    from_date DATE NOT NULL,
    to_date DATE NOT NULL,
    reason TEXT,
    status TEXT DEFAULT 'pending', -- pending, approved, rejected
    risk_score INTEGER, -- AI Analysis
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE public.employee_finance (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    org_id UUID REFERENCES public.organizations(id),
    employee_id UUID REFERENCES public.profiles(id),
    basic_salary NUMERIC,
    hra NUMERIC,
    allowances NUMERIC,
    professional_tax NUMERIC,
    is_active BOOLEAN DEFAULT TRUE
);

CREATE TABLE public.payroll (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    org_id UUID REFERENCES public.organizations(id),
    employee_id UUID REFERENCES public.profiles(id),
    month TEXT, -- Format: "January 2026"
    basic_salary NUMERIC,
    hra NUMERIC,
    allowances NUMERIC,
    professional_tax NUMERIC,
    deductions NUMERIC,
    lop_days NUMERIC, -- Loss of Pay Days
    net_salary NUMERIC,
    status TEXT DEFAULT 'generated',
    generated_by UUID REFERENCES public.profiles(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 4. PROJECT & TASK MANAGEMENT
-------------------------------

CREATE TABLE public.projects (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    org_id UUID REFERENCES public.organizations(id),
    name TEXT NOT NULL,
    status TEXT DEFAULT 'active'
);

CREATE TABLE public.project_members (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    org_id UUID REFERENCES public.organizations(id),
    project_id UUID REFERENCES public.projects(id),
    user_id UUID REFERENCES public.profiles(id),
    role TEXT -- e.g. 'team_lead', 'member'
);

CREATE TABLE public.tasks (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    project_id UUID REFERENCES public.projects(id),
    title TEXT,
    description TEXT,
    assigned_to UUID REFERENCES public.profiles(id),
    status TEXT DEFAULT 'pending',
    priority TEXT,
    due_date TIMESTAMP WITH TIME ZONE
);
